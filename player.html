<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fsh5Flix — المشغل</title>
  <link href="https://vjs.zencdn.net/8.20.0/video-js.css" rel="stylesheet" />
  <style>
    :root{--bg:#000;--accent:#e50914;--accent-600:#c30710;--muted:rgba(255,255,255,0.6)}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#000,#041021);font-family:Inter,system-ui,Arial}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    .top{display:flex;gap:20px;align-items:flex-start}
    .poster{width:320px;min-width:160px;border-radius:12px;overflow:hidden;box-shadow:0 24px 70px rgba(0,0,0,0.7)}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .info{flex:1}
    .title{font-size:24px;color:#fff;font-weight:900;margin-bottom:8px}
    .subnote{color:var(--muted);margin-bottom:12px}
    .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800;box-shadow:0 8px 30px rgba(229,9,20,0.08)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}

    .player-wrap{margin-top:18px}
    .video-js{width:100%;height:56vw;max-height:72vh;border-radius:12px;background:#000}

    /* bigger, clearer episode buttons */
    .episodes{margin-top:18px;display:flex;flex-wrap:wrap;gap:12px}
    .ep{padding:12px 16px;border-radius:12px;background:rgba(255,255,255,0.03);cursor:pointer;font-weight:800;font-size:15px;color:#e6f2f8;border:1px solid rgba(255,255,255,0.03);transition:transform .14s ease,box-shadow .14s}
    .ep:hover{transform:translateY(-6px);box-shadow:0 18px 50px rgba(0,0,0,0.45)}
    .ep.active{background:linear-gradient(90deg,rgba(229,9,20,0.16),rgba(229,9,20,0.06));border-color:rgba(229,9,20,0.28);color:#fff}

    .bottom-note{color:var(--muted);margin-top:10px;font-size:13px}

    /* small responsive tweaks */
    @media (max-width:900px){.top{flex-direction:column}.poster{width:100%}.btn{padding:8px 10px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="poster" id="posterBox"><img id="posterImg" src="" alt="poster"/></div>
      <div class="info">
        <div class="title" id="title"></div>
        <div class="subnote" id="subnote">مشغل Video.js — إذا الترجمات مش ظاهرة سيحاول المشغل تلقائيًا العثور عليها في فولدر المسلسل/اسم الفيلم.</div>
        <div class="controls-row">
          <button class="btn" id="togglePip">Picture-in-Picture</button>
          <a id="downloadBtn" class="btn ghost" href="#" download>تحميل الفيديو</a>
          <button class="btn ghost" id="toggleSub">تفعيل/إيقاف الترجمة</button>
          <button class="btn ghost" id="theater">Theater</button>
        </div>
      </div>
    </div>

    <div class="player-wrap">
      <video id="vjs-player" class="video-js vjs-big-play-centered" controls preload="auto" playsinline></video>
    </div>

    <div class="episodes" id="episodes"></div>
    <div class="bottom-note">سيتم حفظ نقطة التوقف تلقائيًا لاستكمال المشاهدة لاحقًا.</div>
  </div>

  <script src="https://vjs.zencdn.net/8.20.0/video.min.js"></script>
  <script>
    const qs = new URLSearchParams(window.location.search);
    const titleParam = qs.get('title');
    const startIdx = parseInt(qs.get('idx')||'0',10);

    const JSON_URL = '/playlist.json';
    const titleEl = document.getElementById('title');
    const posterImg = document.getElementById('posterImg');
    const episodesEl = document.getElementById('episodes');
    const downloadBtn = document.getElementById('downloadBtn');
    const toggleSubBtn = document.getElementById('toggleSub');
    const pipBtn = document.getElementById('togglePip');
    const theaterBtn = document.getElementById('theater');

    const player = videojs('vjs-player', {controls:true,fluid:true,playbackRates:[0.5,1,1.25,1.5,2]});

    async function load(){
      try{
        const res = await fetch(JSON_URL);
        if(!res.ok) throw new Error('فشل تحميل JSON');
        const data = await res.json();
        const keys = Object.keys(data);
        let chosenTitle = titleParam || keys[0];
        if(!data[chosenTitle]) chosenTitle = keys[0];
        const items = data[chosenTitle];
        setupPlayer(chosenTitle, items, startIdx);
      }catch(err){
        alert('حصل خطأ: '+err.message);
        console.error(err);
      }
    }

    // try to find a valid subtitle URL from several guesses
    async function findSubtitleUrl(title, idx, item){
      const candidates = [];
      // 1) explicit field if provided
      if(item && item.sub) candidates.push(item.sub);
      // 2) common patterns (relative to site root)
      const enc = encodeURIComponent(title);
      const epNum = (idx+1).toString().padStart(2,'0');
      candidates.push(`${enc}/${enc}.vtt`); // e.g. Dexter%20S01/Dexter%20S01.vtt
      candidates.push(`${enc}/E${epNum}.vtt`);
      candidates.push(`${enc}/E${idx+1}.vtt`);
      candidates.push(`${enc}/Episode%20${idx+1}.vtt`);
      candidates.push(`${enc}/e${epNum}.vtt`);
      // also non-encoded friendly guesses (for servers that serve raw spaces)
      candidates.push(`${title}/${title}.vtt`);
      candidates.push(`${title}/E${epNum}.vtt`);
      candidates.push(`${title}/E${idx+1}.vtt`);

      for(const c of candidates){
        try{
          // try HEAD first to avoid downloading whole file
          const resp = await fetch(c, {method: 'HEAD'});
          if(resp.ok) return c;
        }catch(e){
          // ignore and try next
        }
      }
      return null;
    }

    function clearRemoteTracks(){
      const rtt = player.remoteTextTracks();
      for(let j=rtt.length-1;j>=0;j--){ try{ player.removeRemoteTextTrack(rtt[j]); }catch(e){} }
    }

    function highlightEpisode(i){
      const nodes = episodesEl.querySelectorAll('.ep'); nodes.forEach(n=>n.classList.remove('active')); if(nodes[i]) nodes[i].classList.add('active');
    }

    function savePositionKey(title){ return 'fsh5flix_pos_'+encodeURIComponent(title); }

    function playIndexFactory(title, items){
      return async function playIndex(i){
        const it = items[i];
        player.pause();
        player.src({src: it.video, type: 'video/mp4'});
        clearRemoteTracks();
        // try to find subtitle
        const subUrl = await findSubtitleUrl(title, i, it);
        if(subUrl){
          try{ player.addRemoteTextTrack({kind:'subtitles',src:subUrl, srclang:'ar',label:'العربية',default:true}, false); }
          catch(e){ console.warn('تعذر اضافة ترجمات', e); }
        }
        downloadBtn.href = it.video || '#';
        highlightEpisode(i);
        player.ready(()=>{ player.play().catch(()=>{}); });

        // resume logic: if saved time for this title exists and user hasn't started yet, seek to saved
        const key = savePositionKey(title);
        const saved = parseInt(localStorage.getItem(key)||'0',10);
        if(saved>0){
          player.on('play', function handler(){ if(player.currentTime()<1 && saved>0){ player.currentTime(saved); } player.off('play', handler); });
        }

        // update save key to this title
        player.off('timeupdate');
        const key2 = savePositionKey(title);
        player.on('timeupdate', ()=>{ try{ localStorage.setItem(key2, Math.floor(player.currentTime())); }catch(e){} });
      }
    }

    function setupPlayer(title, items, idx){
      titleEl.textContent = title;
      const poster = items[0] && items[0].poster ? items[0].poster : '';
      if(poster) posterImg.src = poster; else posterImg.src='';

      // build episodes list
      episodesEl.innerHTML='';
      items.forEach((it,i)=>{
        const b = document.createElement('div'); b.className='ep'; b.textContent = items.length>1?('E'+(i+1).toString().padStart(2,'0')):'فيلم';
        b.addEventListener('click', ()=>{ playIndex(i); });
        episodesEl.appendChild(b);
      });

      const playIndex = playIndexFactory(title, items);
      // initial play
      playIndex(idx);
      highlightEpisode(idx);

      // download button
      downloadBtn.href = items[idx].video || '#';

      // pip
      pipBtn.addEventListener('click', async ()=>{
        try{ const v = document.querySelector('#vjs-player_html5_api'); if(v) await v.requestPictureInPicture(); }catch(e){ alert('Picture-in-Picture غير مدعوم'); }
      });

      // subtitles toggle
      toggleSubBtn.addEventListener('click', ()=>{
        const tracks = player.textTracks(); if(tracks && tracks.length>0){ for(let i=0;i<tracks.length;i++){ tracks[i].mode = (tracks[i].mode==='showing')? 'disabled' : 'showing'; } } else alert('لا توجد ترجمات مضافة');
      });

      theaterBtn.addEventListener('click', ()=>{ document.body.classList.toggle('theater'); });
    }

    load();

    // stop playback on unload
    window.addEventListener('beforeunload', ()=>{ try{ player.pause(); }catch(e){} });
  </script>
</body>
</html>
